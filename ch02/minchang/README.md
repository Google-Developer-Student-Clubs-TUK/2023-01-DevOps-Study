1. Dockerfile build cache란?

Dockerfile build 과정에서 cache는 빌드 속도를 높이는데 중요한 역할한다. Dockerfile에서 이전 단계에서 빌드된 이미지 레이어를 캐시하여 다음 빌드에서 재사용할 수 있도록하기 때문이다. 

예를 들어 Dockefiledptj 'RUN'명령을 사용해 패키지를 설치하면 이전에 동일한 'RUN'명령을 사용하여 이미지 패키지를 설치했다면, Docker는 이미 설치된 패키지를 다시 설치하지 않고 이전 레이어를 캐시하여 재사용할 수 있다. 

더 자세하게 Dockerfile이 캐시를 사용하는 프로세스에 대해 알아보자면 다음과 같다. 

	1. Dockerfile을 작성한다.
	2. Docker CLI를 사용해 Dockerfile을 빌드한다. 
	3. Docker는 Dockerfile의 각 명령어를 순서대로 실행하며, 명령어마다 새로운 이미지 레이어를 생성한다	  4. 각 이미지 레이어는 해당 레이어의 내용과 레이어 ID를 가지고 있다. 
	5. Docker 는 각 이미지 레이어를 캐시한다. 이전에 빌드한 이미지 레이어와 동일한 레이어 ID를 가진 레이어는 캐시를 사용해 빌드하지 않는다. 
	6. Dockerfile이 변경되지 않은 경우, 캐시된 이미지 레이어를 사용하여 빌드를 빠르게 완료한다. 
	7. Dockerfile이 변경되었거나, 이전에 캐시된 이미지 레이어가 사용할 수 없는 경우, Docker는 해당 이미지 레이어를 다시 빌드한다. 

그러나 캐시를 사용하는 것이 항상 바람직 하지는 않다. Dockerfile에서 'RUN' 명령 이후에 추가되는 명령은 해당 'RUN' 명령 이후의 이미지 레이어에만 영향을 미치기 때문에 이전 캐시를 사용하면 예기치 않은 동작이 발생할 수 있다. 

예를들어 패키지 업데이트를 하는 'RUN apt-get update' 명령을 추가한 경우 이전 캐시를 적용하면 업데이트가 적용되지 않을 수 있다. 이런 경우 '--no-cache' 옵션을 사용해 이전 캐시를 무시하고 새로운 이미지를 빌드할 수 있다.


2. multi stage build란?

multi stage build는 Dockerfile에서 여러개의 FORM 명령을 사용해 하나의 Dockerfile에서 여러 단계의 빌드를 수행하는 기술이다. 이를 사용하면 하나의 Dockerfile에서 빌드에 필요한 모든 파일과 명령을 정의할 수 있다. 

보통 Dockerfile에서는 빌드 시에 필요한 모든 종속성을 포함하는 이미지를 만들어야 한다. 이렇게하면 이미지의 크기가 커지고 불필요한 파일이 포함될 수 있다. 

multi stage build를 사용하면 빌드시에 필요한 종속성만 포함하는 최종 이미지를 만들 수 있으므로 이미지 크기가 줄고 보안도 강화할 수 있다. 

사용하는 방법은 다음과 같다. 

여러개의 FROM 명령을 사용해 각각 다른 빌드 단계를 정의하고 각 빌드 단계에서 필요한 파일과 명령을 추가한다.빌드단계는 각각 다른 이름을 가질 수 있으며, 각 단계에서 만들어진 파일과 명령은 다음 단계에서 사용될 수 있다. 

예를 들어, Node.js 애플리케이션을 빌드하는 Dockerfile에서, 첫 번째 단계에서는 Node.js 종속성을 설치하고, 두 번째 단계에서는 Node.js 애플리케이션을 빌드한다.  첫 번째 단계에서는 Node.js 이미지를 사용하여 종속성을 설치하고, 두 번째 단계에서는 이전 단계에서 설치된 종속성을 사용하여 애플리케이션을 빌드합니다. 이렇게 하면 최종 이미지에는 Node.js 이미지 대신 빌드된 애플리케이션만 포함된다.

코드 예시는 다음과 같다. 

''' 
# 빌드 단계 1 - 종속성 설치
FROM node:14.17.0-alpine AS build

WORKDIR /app

COPY package*.json ./

RUN npm install

# 빌드 단계 2 - 애플리케이션 빌드
FROM node:14.17.0-alpine

WORKDIR /app

COPY --from=build /app/node_modules ./node_modules

COPY . .

RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]

''' 

위의 Dockerfile에서 첫 번째 빌드 단계에서는 node:14.17.0-alpine 이미지를 사용하여 npm install 명령을 실행하여 애플리케이션에 필요한 종속성을 설치한다.  빌드 단계 1의 결과물은 두 번째 빌드 단계에서 사용됩니다.

두 번째 빌드 단계에서는 빌드된 애플리케이션을 포함하는 새로운 이미지를 생성한다. 첫 번째 빌드 단계에서 설치된 종속성은 --from=build 옵션을 사용하여 두 번째 빌드 단계에서 사용된다.

두 번째 빌드 단계에서는 npm run build 명령을 실행하여 애플리케이션을 빌드한다.  그 후에 EXPOSE 명령으로 포트 3000을 열고, CMD 명령으로 애플리케이션을 실행한다.

이렇게 하면 최종 이미지에서는 Node.js이미지 대신 빌드된 애플리케이션이 포함된다.


